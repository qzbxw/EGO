name: ğŸš€ Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ============================================
  # ğŸš€ Deploy to VPS
  # ============================================
  deploy:
    name: ğŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: ğŸ“‹ Deployment Started
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                   â•‘"
          echo "â•‘  ğŸš€ Starting EGO Deployment                       â•‘"
          echo "â•‘                                                   â•‘"
          echo "â•‘  Branch:  ${{ github.ref_name }}                 â•‘"
          echo "â•‘  Commit:  ${{ github.sha }}                      â•‘"
          echo "â•‘  Author:  ${{ github.actor }}                    â•‘"
          echo "â•‘                                                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“ Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ” Check VPS connection
        run: |
          echo "âœ… Testing SSH connection..."
          ssh -p ${{ secrets.SSH_PORT }} -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'Connection successful!'"

      - name: ğŸ“¦ Pull latest code on VPS
        run: |
          echo "ğŸ“¦ Pulling latest code..."
          ssh -p ${{ secrets.SSH_PORT }} -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH || '/home/ubuntu/EGO' }}
            echo "Current directory: $(pwd)"
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            echo "âœ… Code updated to: $(git rev-parse --short HEAD)"
          EOF

      - name: ğŸ³ Build Docker images
        run: |
          echo "ğŸ³ Building Docker images with cache..."
          ssh -p ${{ secrets.SSH_PORT }} -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH || '/home/ubuntu/EGO' }}
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1

            echo "Building frontend..."
            docker compose build frontend

            echo "Building go-api..."
            docker compose build go-api

            echo "Building python-api..."
            docker compose build python-api

            echo "âœ… All images built successfully"
          EOF

      - name: ğŸ”„ Restart services
        run: |
          echo "ğŸ”„ Restarting services..."
          ssh -p ${{ secrets.SSH_PORT }} -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH || '/home/ubuntu/EGO' }}

            echo "Stopping old containers..."
            docker compose down

            echo "Starting new containers..."
            docker compose up -d

            echo "âœ… Services restarted"
          EOF

      - name: ğŸ§¹ Cleanup old images
        run: |
          echo "ğŸ§¹ Cleaning up old Docker images..."
          ssh -p ${{ secrets.SSH_PORT }} -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            docker image prune -f
            echo "âœ… Cleanup complete"
          EOF

      - name: ğŸ” Health Check
        run: |
          echo "ğŸ” Running health checks..."
          ssh -p ${{ secrets.SSH_PORT }} -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH || '/home/ubuntu/EGO' }}

            echo ""
            echo "Services status:"
            docker compose ps

            echo ""
            echo "Waiting for services to be healthy..."
            sleep 10

            # Check frontend
            if docker compose ps frontend | grep -q "Up"; then
              echo "âœ… Frontend: Running"
            else
              echo "âŒ Frontend: Not running"
              exit 1
            fi

            # Check go-api
            if docker compose ps go-api | grep -q "Up"; then
              echo "âœ… Go API: Running"
            else
              echo "âŒ Go API: Not running"
              exit 1
            fi

            # Check python-api
            if docker compose ps python-api | grep -q "Up"; then
              echo "âœ… Python API: Running"
            else
              echo "âŒ Python API: Not running"
              exit 1
            fi

            # Check postgres
            if docker compose ps postgres-db | grep -q "healthy"; then
              echo "âœ… PostgreSQL: Healthy"
            else
              echo "âš ï¸  PostgreSQL: Starting..."
            fi

            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                                                   â•‘"
            echo "â•‘  âœ… All services are running!                     â•‘"
            echo "â•‘                                                   â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          EOF

      - name: ğŸ“Š Show logs (last 50 lines)
        if: always()
        run: |
          echo "ğŸ“Š Recent logs:"
          ssh -p ${{ secrets.SSH_PORT }} -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH || '/home/ubuntu/EGO' }}
            docker compose logs --tail=50
          EOF

      - name: ğŸ‰ Deployment Complete
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                   â•‘"
          echo "â•‘  ğŸ‰ Deployment Successful!                        â•‘"
          echo "â•‘                                                   â•‘"
          echo "â•‘  Commit: ${{ github.sha }}                       â•‘"
          echo "â•‘  Time: $(date)                                   â•‘"
          echo "â•‘                                                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                   â•‘"
          echo "â•‘  âŒ Deployment Failed!                            â•‘"
          echo "â•‘                                                   â•‘"
          echo "â•‘  Check the logs above for details.               â•‘"
          echo "â•‘                                                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1

  # ============================================
  # ğŸ“¢ Notification (optional)
  # ============================================
  notify:
    name: ğŸ“¢ Send Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: ğŸ“¢ Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment succeeded"
          else
            echo "âŒ Deployment failed"
          fi
