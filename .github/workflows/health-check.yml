name: ğŸ¥ Health Check

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: ğŸ¥ Check Services Health
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“ Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ” Check Services
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     ğŸ¥ EGO Health Check                           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH || '/home/ubuntu/EGO' }}

            echo "Services Status:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Check each service
            services=("frontend" "go-api" "python-api" "postgres-db" "minio" "nginx-proxy")
            all_healthy=true

            for service in "${services[@]}"; do
              if docker compose ps $service | grep -q "Up"; then
                echo "âœ… $service: Running"
              else
                echo "âŒ $service: Down"
                all_healthy=false
              fi
            done

            echo ""
            echo "Docker Stats:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"

            echo ""
            echo "Disk Usage:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            df -h | grep -E '^/dev/'

            if [ "$all_healthy" = false ]; then
              echo ""
              echo "âš ï¸  Some services are down! Check logs."
              exit 1
            else
              echo ""
              echo "âœ… All services healthy!"
            fi
          EOF

      - name: ğŸ”„ Restart unhealthy services
        if: failure()
        run: |
          echo "ğŸ”„ Attempting to restart services..."
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH || '/home/ubuntu/EGO' }}
            docker compose restart
            sleep 10
            docker compose ps
          EOF
